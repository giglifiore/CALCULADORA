<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Calculadora</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta http-equiv="Cache-Control" content="no-store" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#ffffff">

<style>
body { font-family: Arial; background:#f2f2f2; margin:0; }
#calc, #chat { padding:20px; }
#display {
  width:100%; font-size:2em; padding:10px;
  text-align:right; margin-bottom:10px;
}
button {
  width:20%; padding:20px; margin:1%;
  font-size:1.2em;
}
#messages {
  height:60vh;
  background:white;
  overflow-y:auto;
  padding:10px;
  margin-bottom:10px;
}
  .msg {
  padding: 8px 10px;
  margin: 6px 0;
  max-width: 75%;
  border-radius: 10px;
  word-wrap: break-word;
  font-size: 0.95em;
}

.mine {
  background: #d1f5d3;
  margin-left: auto;
  text-align: right;
}

.other {
  background: #eee;
  margin-right: auto;
  text-align: left;
}

</style>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>

<body>

<!-- CALCULADORA -->
<div id="calc">
  <input id="display" disabled />
  <div>
    <button onclick="press('7')">7</button>
    <button onclick="press('8')">8</button>
    <button onclick="press('9')">9</button>
    <button onclick="press('/')">√∑</button>

    <button onclick="press('4')">4</button>
    <button onclick="press('5')">5</button>
    <button onclick="press('6')">6</button>
    <button onclick="press('*')">√ó</button>

    <button onclick="press('1')">1</button>
    <button onclick="press('2')">2</button>
    <button onclick="press('3')">3</button>
    <button onclick="press('-')">‚àí</button>

    <button onclick="press('0')">0</button>
    <button onclick="clearDisplay()">C</button>
    <button onclick="equals()">=</button>
    <button onclick="press('+')">+</button>
  </div>
</div>

<!-- CHAT -->
<div id="chat" style="display:none;">
  <h3>Memo</h3>
  <div id="messages"></div>
  <input id="msg" placeholder="Escribe..." />
  <button onclick="send()">Enviar</button>
</div>

<script>
/* =========================
   CONFIGURACI√ìN
========================= */
/* =========================
   ID √öNICO DEL USUARIO
========================= */
const MY_ID = localStorage.getItem("memo_id") || crypto.randomUUID();
localStorage.setItem("memo_id", MY_ID);

//const SECRET = "1990"; // üîê CLAVE DE LA CALCULADORA
let ROOM = null;
let chatRef = null;

/* =========================
   FIREBASE CONFIG
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyAsKJn2Z5Jb5iW4H8OjUBIXmZWXekGXCyU",
  authDomain: "chatarea-6170e.firebaseapp.com",
  projectId: "chatarea-6170e",
  storageBucket: "chatarea-6170e.firebasestorage.app",
  messagingSenderId: "147913199399",
  appId: "1:147913199399:web:886f09ab74017b3fc22302",
  databaseURL: "https://chatarea-6170e-default-rtdb.firebaseio.com"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* =========================
   CALCULADORA
========================= */
let input = "";

function press(v) {
  input += v;
  display.value = input;
}

function clearDisplay() {
  input = "";
  display.value = "";
}
  // cualquier clave de 4+ caracteres abre un chat
 /* if (input.length >= 4) {
    abrirChat(input);
    input = "";
    display.value = "";
    return;
  }*/

 function equals() {
  if (!input) return;

  // üëâ 1. NUEVO CHAT: ++1990
  if (/^\+\+\d+$/.test(input)) {
    const codigo = input.slice(2); // quita "++"
    abrirChat(codigo);
    input = "";
    display.value = "";
    return;
  }

  // üëâ 2. CHAT EXISTENTE: 1990
  if (/^\d+$/.test(input)) {
    if (existeChat(input)) {
      abrirChat(input);
      input = "";
      display.value = "";
      return;
    }
    // si no existe, cae a calculadora
  }

  // üëâ 3. CALCULADORA NORMAL
  try {
    display.value = eval(input);
    input = display.value.toString();
  } catch {
    display.value = "Error";
    input = "";
  }
}






/* =========================
   CHAT FIREBASE
========================= */
function abrirChat(clave) {
  ROOM = "room_" + clave;
  chatRef = db.ref("chats/" + ROOM);

  calc.style.display = "none";
  chat.style.display = "block";
  messages.innerHTML = "";

 /* chatRef.limitToLast(50).on("child_added", snap => {
    const data = snap.val();
    let d = document.createElement("div");
    d.textContent = data.text;
    messages.appendChild(d);
  });*/
  chatRef.limitToLast(50).on("child_added", snap => {
  const data = snap.val();

  let d = document.createElement("div");
  d.classList.add("msg");

  if (data.uid === MY_ID) {
    d.classList.add("mine");
  } else {
    d.classList.add("other");
  }

  d.textContent = data.text;
  messages.appendChild(d);
  messages.scrollTop = messages.scrollHeight;
});

}


/*function send() {
  const text = msg.value;
  if (!text || !chatRef) return;

  chatRef.push({
    text: text,
    time: Date.now()
  });

  msg.value = "";
}*/

  function send() {
  const text = msg.value.trim();
  if (!text || !chatRef) return;

  chatRef.push({
    text: text,
    uid: MY_ID,
    time: Date.now()
  });

  msg.value = "";
}


/* =========================
   MODO P√ÅNICO (OPCI√ìN C)
   Doble toque + Sacudir
========================= */
let lastTap = 0;

chat.addEventListener("touchend", () => {
  const now = Date.now();
  if (now - lastTap < 300) activarPanico();
  lastTap = now;
});

let lx, ly, lz;
const SHAKE_THRESHOLD = 22;

window.addEventListener("devicemotion", e => {
  if (!chatRef || chat.style.display === "none") return;

  const a = e.accelerationIncludingGravity;
  if (!a) return;

  if (lx === undefined) {
    lx = a.x; ly = a.y; lz = a.z;
    return;
  }

  const delta =
    Math.abs(a.x - lx) +
    Math.abs(a.y - ly) +
    Math.abs(a.z - lz);

  if (delta > SHAKE_THRESHOLD) activarPanico();

  lx = a.x; ly = a.y; lz = a.z;
});

/* =========================
   FUNCI√ìN P√ÅNICO
========================= */
function activarPanico() {
  //if (chatRef) chatRef.remove(); // borra para ambos
  //messages.innerHTML = "";
  msg.value = "";
  chat.style.display = "none";
  calc.style.display = "block";
}

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/sw.js");
}

  
</script>

</body>
</html>











